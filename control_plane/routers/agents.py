"""
Agent marketplace endpoints.
Handles agent listing, details, creation, and management.
"""

from typing import List, Optional

from fastapi import APIRouter, Depends, HTTPException, Query, status
from sqlalchemy.ext.asyncio import AsyncSession

from control_plane.database import get_session
from control_plane.schemas import (
    AgentCreate,\n    AgentResponse,\n    AgentStatus,\n    AgentUpdate,\n)\n\nrouter = APIRouter()\n\n\n@router.get(\"/agents\", response_model=List[AgentResponse])\nasync def list_agents(\n    category: Optional[str] = Query(None),\n    search: Optional[str] = Query(None),\n    skip: int = Query(0, ge=0),\n    limit: int = Query(10, ge=1, le=100),\n    session: AsyncSession = Depends(get_session),\n):\n    \"\"\"\n    List all published agents in the marketplace.\n    Supports filtering by category and search.\n    \"\"\"\n    # TODO: Implement database query\n    # For now, return mock data\n    return [\n        AgentResponse(\n            id=1,\n            agent_id=\"com.aicloud.finops.billing-normalizer\",\n            name=\"Billing Normalizer\",\n            description=\"Normalize provider billing data\",\n            version=\"1.0.0\",\n            status=AgentStatus.PUBLISHED,\n            category=\"finops\",\n            tags=[\"billing\", \"normalization\"],\n            rating=4.8,\n            review_count=42,\n            price=99.0,\n            risk_level=\"low\",\n            developer_id=1,\n            created_at=\"2025-01-01T00:00:00\",\n            updated_at=\"2025-01-01T00:00:00\",\n        )\n    ]\n\n\n@router.get(\"/agents/{agent_id}\", response_model=AgentResponse)\nasync def get_agent(\n    agent_id: str,\n    session: AsyncSession = Depends(get_session),\n):\n    \"\"\"\n    Get detailed information about a specific agent.\n    \"\"\"\n    # TODO: Implement database query\n    return AgentResponse(\n        id=1,\n        agent_id=agent_id,\n        name=\"Billing Normalizer\",\n        description=\"Normalize provider billing data\",\n        version=\"1.0.0\",\n        status=AgentStatus.PUBLISHED,\n        category=\"finops\",\n        tags=[\"billing\", \"normalization\"],\n        rating=4.8,\n        review_count=42,\n        price=99.0,\n        risk_level=\"low\",\n        developer_id=1,\n        created_at=\"2025-01-01T00:00:00\",\n        updated_at=\"2025-01-01T00:00:00\",\n    )\n\n\n@router.post(\"/agents\", response_model=AgentResponse, status_code=status.HTTP_201_CREATED)\nasync def create_agent(\n    agent_create: AgentCreate,\n    session: AsyncSession = Depends(get_session),\n):\n    \"\"\"\n    Create a new agent (developer only).\n    Submits agent manifest for review.\n    \"\"\"\n    # TODO: Implement database insertion\n    # TODO: Validate manifest\n    # TODO: Scan container image\n    # TODO: Create approval workflow\n    return AgentResponse(\n        id=1,\n        agent_id=agent_create.manifest.agent_id,\n        name=agent_create.manifest.name,\n        description=agent_create.manifest.description,\n        version=agent_create.manifest.version,\n        status=AgentStatus.SUBMITTED,\n        category=agent_create.manifest.category,\n        tags=agent_create.manifest.tags,\n        rating=0.0,\n        review_count=0,\n        price=0.0,\n        risk_level=agent_create.manifest.risk_level,\n        developer_id=1,\n        created_at=\"2025-01-01T00:00:00\",\n        updated_at=\"2025-01-01T00:00:00\",\n    )\n\n\n@router.put(\"/agents/{agent_id}\", response_model=AgentResponse)\nasync def update_agent(\n    agent_id: str,\n    agent_update: AgentUpdate,\n    session: AsyncSession = Depends(get_session),\n):\n    \"\"\"\n    Update an existing agent (developer only).\n    \"\"\"\n    # TODO: Implement database update\n    # TODO: Validate permissions\n    return AgentResponse(\n        id=1,\n        agent_id=agent_id,\n        name=agent_update.name or \"Billing Normalizer\",\n        description=agent_update.description or \"Normalize provider billing data\",\n        version=\"1.0.1\",\n        status=AgentStatus.DRAFT,\n        category=\"finops\",\n        tags=agent_update.tags or [\"billing\"],\n        rating=4.8,\n        review_count=42,\n        price=99.0,\n        risk_level=\"low\",\n        developer_id=1,\n        created_at=\"2025-01-01T00:00:00\",\n        updated_at=\"2025-01-02T00:00:00\",\n    )\n\n\n@router.delete(\"/agents/{agent_id}\", status_code=status.HTTP_204_NO_CONTENT)\nasync def delete_agent(\n    agent_id: str,\n    session: AsyncSession = Depends(get_session),\n):\n    \"\"\"\n    Delete an agent (developer only).\n    \"\"\"\n    # TODO: Implement database deletion\n    # TODO: Validate permissions\n    # TODO: Handle existing deployments\n    return None\n\n\n@router.post(\"/agents/{agent_id}/publish\", response_model=AgentResponse)\nasync def publish_agent(\n    agent_id: str,\n    session: AsyncSession = Depends(get_session),\n):\n    \"\"\"\n    Publish an agent to the marketplace (admin only).\n    \"\"\"\n    # TODO: Implement publish logic\n    # TODO: Validate agent status\n    # TODO: Update agent status to PUBLISHED\n    return AgentResponse(\n        id=1,\n        agent_id=agent_id,\n        name=\"Billing Normalizer\",\n        description=\"Normalize provider billing data\",\n        version=\"1.0.0\",\n        status=AgentStatus.PUBLISHED,\n        category=\"finops\",\n        tags=[\"billing\"],\n        rating=0.0,\n        review_count=0,\n        price=99.0,\n        risk_level=\"low\",\n        developer_id=1,\n        created_at=\"2025-01-01T00:00:00\",\n        updated_at=\"2025-01-02T00:00:00\",\n    )\n\n\n@router.get(\"/agents/search\")\nasync def search_agents(\n    q: str = Query(..., min_length=1),\n    session: AsyncSession = Depends(get_session),\n):\n    \"\"\"\n    Full-text search for agents.\n    \"\"\"\n    # TODO: Implement full-text search\n    return {\"results\": [], \"total\": 0}\n"
